const f={fetchData:async()=>{const a=window.RedmineCanvasGantt;if(!a)throw new Error("Configuration not found");const n=t=>{if(!t)return null;const o=new Date(t).getTime();return Number.isFinite(o)?o:null},e=await fetch(`${a.apiBase}/data.json`,{headers:{"X-Redmine-API-Key":a.apiKey,"Content-Type":"application/json"}});if(!e.ok)throw new Error(`API Error: ${e.statusText}`);const i=await e.json(),s=i.tasks.map((t,o)=>{const d=n(t.start_date),c=n(t.due_date),r=d??c??new Date().setHours(0,0,0,0),u=c??d??r,l=u<r?r:u;return{id:String(t.id),subject:t.subject,startDate:r,dueDate:l,ratioDone:t.ratio_done??0,statusId:t.status_id,assignedToId:t.assigned_to_id,assignedToName:t.assigned_to_name,parentId:t.parent_id?String(t.parent_id):void 0,lockVersion:t.lock_version,editable:t.editable,rowIndex:o,hasChildren:!1}}),p=new Set(s.filter(t=>t.parentId).map(t=>t.parentId));return s.forEach(t=>{p.has(t.id)&&(t.hasChildren=!0)}),{...i,tasks:s}},updateTask:async a=>{const n=window.RedmineCanvasGantt;if(!n)throw new Error("Configuration not found");const e=await fetch(`${n.apiBase}/tasks/${a.id}.json`,{method:"PATCH",headers:{"X-Redmine-API-Key":n.apiKey,"Content-Type":"application/json","X-CSRF-Token":n.authToken},body:JSON.stringify({task:{start_date:new Date(a.startDate).toISOString().split("T")[0],due_date:new Date(a.dueDate).toISOString().split("T")[0],lock_version:a.lockVersion}})});return e.status===409?{status:"conflict",error:"This task was updated by another user. Please reload."}:e.ok?{status:"ok",lockVersion:(await e.json()).lock_version}:{status:"error",error:(await e.json().catch(()=>({}))).error||e.statusText}}};export{f as apiClient};
