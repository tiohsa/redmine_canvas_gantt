const w={fetchData:async()=>{const a=window.RedmineCanvasGantt;if(!a)throw new Error("Configuration not found");const n=t=>{if(!t)return null;const s=new Date(t).getTime();return Number.isFinite(s)?s:null},e=await fetch(`${a.apiBase}/data.json`,{headers:{"X-Redmine-API-Key":a.apiKey,"Content-Type":"application/json"}});if(!e.ok)throw new Error(`API Error: ${e.statusText}`);const r=await e.json(),i=r.tasks.map((t,s)=>{const d=n(t.start_date),c=n(t.due_date),o=d??c??new Date().setHours(0,0,0,0),u=c??d??o,p=u<o?o:u;return{id:String(t.id),subject:t.subject,startDate:o,dueDate:p,ratioDone:t.ratio_done??0,statusId:t.status_id,assignedToId:t.assigned_to_id,assignedToName:t.assigned_to_name,parentId:t.parent_id,lockVersion:t.lock_version,editable:t.editable,rowIndex:s}});return{...r,tasks:i}},updateTask:async a=>{const n=window.RedmineCanvasGantt;if(!n)throw new Error("Configuration not found");const e=await fetch(`${n.apiBase}/tasks/${a.id}.json`,{method:"PATCH",headers:{"X-Redmine-API-Key":n.apiKey,"Content-Type":"application/json","X-CSRF-Token":n.authToken},body:JSON.stringify({task:{start_date:new Date(a.startDate).toISOString().split("T")[0],due_date:new Date(a.dueDate).toISOString().split("T")[0],lock_version:a.lockVersion}})});return e.status===409?{status:"conflict",error:"This task was updated by another user. Please reload."}:e.ok?{status:"ok",lockVersion:(await e.json()).lock_version}:{status:"error",error:(await e.json().catch(()=>({}))).error||e.statusText}}};export{w as apiClient};
