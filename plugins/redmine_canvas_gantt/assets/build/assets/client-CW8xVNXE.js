const r={fetchData:async()=>{const e=window.RedmineCanvasGantt;if(!e)throw new Error("Plugin configuration not found");const a=await fetch(`${e.apiBase}/data.json`,{headers:{"X-Redmine-API-Key":e.apiKey,"Content-Type":"application/json"}});if(!a.ok)throw new Error(`API Error: ${a.statusText}`);const n=await a.json(),o=n.tasks.map((t,s)=>({id:String(t.id),subject:t.subject,startDate:new Date(t.start_date).getTime(),dueDate:new Date(t.due_date).getTime(),ratioDone:t.ratio_done,statusId:t.status_id,assignedToId:t.assigned_to_id,assignedToName:t.assigned_to_name,parentId:t.parent_id,lockVersion:t.lock_version,editable:t.editable,rowIndex:s}));return{...n,tasks:o}},updateTask:async e=>{const a=window.RedmineCanvasGantt;if(!a)throw new Error("Plugin configuration not found");const n=await fetch(`${a.apiBase}/tasks/${e.id}.json`,{method:"PATCH",headers:{"X-Redmine-API-Key":a.apiKey,"Content-Type":"application/json","X-CSRF-Token":a.authToken},body:JSON.stringify({task:{start_date:new Date(e.startDate).toISOString().split("T")[0],due_date:new Date(e.dueDate).toISOString().split("T")[0],lock_version:e.lockVersion}})});return n.status===409?{status:"conflict",error:"This task was updated by another user. Please reload."}:n.ok?{status:"ok",lockVersion:(await n.json()).lock_version}:{status:"error",error:(await n.json().catch(()=>({}))).error||n.statusText}}};export{r as apiClient};
