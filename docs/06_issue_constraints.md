# 6. Redmine チケットの制約・関係性整理

本ガントチャートプラグインでは、Redmine チケット（Issue）が持つ構造的・業務的な制約を正しく理解・反映する必要があります。本章では、親子関係・チケット間関係・日付・状態など、ガント描画・編集時に考慮すべき制約を整理します。

## 6.1 親チケット・子チケットの制約（Issue Hierarchy）

Redmine のチケットは parent_id によりツリー構造（WBS）を形成できます。

### 基本ルール
- 親チケットは複数の子チケットを持てる
- 子チケットは必ず1つの親チケットのみを持つ
- 多階層（孫チケット）も可能

### 日付・進捗の暗黙ルール（運用慣習）
- 親チケットの開始日は **最も早い子チケット開始日以下** であることが望ましい
- 親チケットの終了日は **最も遅い子チケット終了日以上** であることが望ましい
- 親チケットの進捗率は以下のいずれかで運用されることが多い
  - 子チケット進捗の加重平均
  - 子チケット完了数ベース

※ Redmine 本体ではこれらは「強制制約」ではなく論理制約（慣習）である点に注意

### ガント実装上の考慮点
- 親チケットは「集約バー（summary task）」として描画
- 親チケットを直接ドラッグ編集するかは設定で制御（推奨：直接編集不可）
- 子チケット移動時に親バーの自動再計算が必要

## 6.2 チケット間の関係（Issue Relations）

Redmine は issue_relations によりチケット間の依存関係を表現できます。

### 標準の関係タイプ
- precedes / follows（先行・後続）
- blocks / blocked（ブロック関係）
- relates（単なる関連）
- duplicates / duplicated（重複）
- copied_to / copied_from（コピー元/先）

### ガントで意味を持つ関係
- precedes / follows
- blocks / blocked（運用次第）

### 制約ルール（論理）
- precedes: 後続チケットの開始日は、先行チケットの終了日以降であるべき
- blocks: ブロック元が未完了の場合、ブロック先は開始/完了不可（状態制約）

### ガント実装上の考慮点
- 依存線は OverlayCanvas に Manhattan path で描画
- 後続チケットを前にドラッグした場合は以下のいずれか
  - 移動を禁止
  - 自動スナップ
  - 警告表示（UX 重視）

## 6.3 ステータス（状態）による制約

Redmine チケットはワークフローに基づく状態遷移を持ちます。

### 代表的な状態
- New / In Progress / Resolved / Closed など

### 制約例（運用依存）
- Closed のチケットは日付変更不可
- Resolved 以降は進捗 100% 固定

### ガント実装上の考慮点
- 状態に応じてバーの色・操作可否を変更
- Closed チケットはドラッグ・リサイズ不可にする設定を推奨

## 6.4 日付に関する制約

Redmine チケットの日付項目
- start_date（開始日）
- due_date（期限日）
- estimated_hours（工数）

### 制約・注意点
- start_date 未設定のチケットが存在する
- due_date のみ設定されているケースが多い
- 開始日 > 期限日の不正データが存在する場合がある

### ガント実装上の対策
- 日付未設定の場合のデフォルト補完ルールを定義
- 不正データは警告表示しつつ描画

## 6.5 プロジェクト・バージョン（マイルストーン）制約

チケットは Version（Fixed version）に紐づく場合があります。Version は開始日・期限日を持ちます。

### ガント実装上の扱い
- Version をマイルストーンとして別レーンに描画
- Version 期限を超えるチケットを警告表示

## 6.6 クロスプロジェクト制約

- 親子関係は同一プロジェクト内が原則
- 関係（relates 等）はプロジェクトを跨ぐことが可能

### ガント実装上の考慮
- MVP では同一プロジェクトのみ表示
- 将来拡張でマルチプロジェクト対応

## 6.7 制約の整理（一覧表）

| 分類   | 制約内容             | ガントでの扱い       |
| ------ | -------------------- | -------------------- |
| 親子   | 親は子を内包         | 集約バーとして描画   |
| 親子   | 子移動で親期間変動   | 自動再計算           |
| 関係   | precedes / follows   | 依存線 + 移動制約    |
| 状態   | Closed は編集不可    | ドラッグ無効         |
| 日付   | 未設定日付あり       | デフォルト補完       |
| Version | 期限超過            | 警告表示             |
